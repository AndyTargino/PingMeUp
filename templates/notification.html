<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PingMeUp Notification</title>
    <link rel="stylesheet" href="../styles/notification.css">
</head>
<body>
    <div id="notificationContainer" class="notification-container">
        <!-- Priority indicator -->
        <div class="priority-indicator"></div>
        
        <!-- Main notification content -->
        <div class="notification-main">
            <!-- Badge (for grouped notifications) -->
            <div class="notification-badge" style="display: none;">
                <span class="badge-count">0</span>
            </div>
            
            <!-- Icon -->
            <div class="notification-icon"></div>
            
            <!-- Content area -->
            <div class="notification-content">
                <div class="notification-title"></div>
                <div class="notification-subtitle" style="display: none;"></div>
                <div class="notification-message"></div>
                <div class="notification-time"></div>
                
                <!-- Rich content area -->
                <div class="notification-image" style="display: none;">
                    <img src="" alt="Notification image" />
                </div>
                
                <!-- Achievement specific content -->
                <div class="achievement-content" style="display: none;">
                    <div class="achievement-level"></div>
                    <div class="achievement-points"></div>
                    <div class="confetti-container"></div>
                </div>
                
                <!-- Weather specific content -->
                <div class="weather-content" style="display: none;">
                    <div class="weather-main">
                        <div class="weather-temperature"></div>
                        <div class="weather-condition"></div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-humidity"></div>
                        <div class="weather-location"></div>
                    </div>
                </div>
                
                <!-- Update/System specific content -->
                <div class="update-content" style="display: none;">
                    <div class="update-version"></div>
                    <div class="update-mandatory" style="display: none;">
                        <span class="mandatory-badge">Required</span>
                    </div>
                </div>
            </div>
            
            <!-- Close button -->
            <div class="notification-close" onclick="closeNotification()">&#x2715;</div>
        </div>
        
        <!-- Progress Bar (for progress-type notifications) -->
        <div class="progress-container" style="display: none;">
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
                <div class="progress-spinner" style="display: none;"></div>
            </div>
            <div class="progress-details">
                <div class="progress-text">0%</div>
                <div class="progress-speed" style="display: none;"></div>
                <div class="progress-time" style="display: none;"></div>
            </div>
            <div class="progress-actions" style="display: none;">
                <button class="progress-pause" onclick="pauseProgress()">‚è∏</button>
                <button class="progress-cancel" onclick="cancelProgress()">‚úï</button>
            </div>
        </div>
        
        <!-- Reply Input (for reply-type notifications) -->
        <div class="reply-container" style="display: none;">
            <div class="input-container">
                <input type="text" class="reply-input" placeholder="">
                <textarea class="reply-textarea" placeholder="" style="display: none;"></textarea>
            </div>
            <div class="reply-buttons">
                <button class="reply-button send" onclick="sendReply()">Send</button>
                <button class="reply-button cancel" onclick="cancelReply()">Cancel</button>
            </div>
            <div class="input-validation" style="display: none;"></div>
        </div>
        
        <!-- Action Buttons (for confirmation, reminder, etc.) -->
        <div class="action-buttons" style="display: none;"></div>
        
        <!-- Snooze Options (for reminders) -->
        <div class="snooze-options" style="display: none;">
            <div class="snooze-title">Snooze for:</div>
            <div class="snooze-buttons">
                <button class="snooze-btn" data-minutes="5">5 min</button>
                <button class="snooze-btn" data-minutes="15">15 min</button>
                <button class="snooze-btn" data-minutes="30">30 min</button>
                <button class="snooze-btn" data-minutes="60">1 hour</button>
            </div>
        </div>
        
        <!-- Auto-close progress bar -->
        <div class="notification-progress"></div>
        
        <!-- Drag handle -->
        <div class="drag-handle" style="display: none;"></div>
    </div>

    <script>
        console.log('PingMeUp notification system loaded');
        
        let notificationData = null;
        let notificationId = null;
        let animationTimeouts = [];
        let progressInterval = null;
        
        // Enhanced icon library
        const NOTIFICATION_ICONS = {
            // Basic types
            info: '&#x2139;',        // ‚ÑπÔ∏è
            success: '&#x2714;',     // ‚úÖ
            warning: '&#x26A0;',     // ‚ö†Ô∏è
            error: '&#x274C;',       // ‚ùå
            custom: '&#x1F514;',     // üîî
            
            // Interactive types
            progress: '&#x1F552;',   // üïí
            reply: '&#x1F4DD;',      // üìù
            confirmation: '&#x2753;', // ‚ùì
            input: '&#x270F;',       // ‚úèÔ∏è
            
            // Advanced types
            achievement: '&#x1F3C6;', // üèÜ
            update: '&#x1F504;',     // üîÑ
            download: '&#x2B07;',    // ‚¨áÔ∏è
            upload: '&#x2B06;',      // ‚¨ÜÔ∏è
            system: '&#x2699;',      // ‚öôÔ∏è
            security: '&#x1F512;',   // üîí
            reminder: '&#x23F0;',    // ‚è∞
            calendar: '&#x1F4C5;',   // üìÖ
            
            // Creative types
            loading: '&#x23F3;',     // ‚è≥
            celebration: '&#x1F389;', // üéâ
            weather: '&#x2601;',     // ‚òÅÔ∏è
            notification: '&#x1F4E2;', // üì¢
            alert: '&#x1F6A8;',      // üö®
            tip: '&#x1F4A1;',        // üí°
            news: '&#x1F4F0;',       // üì∞
            promotional: '&#x1F4E3;'  // üì£
        };
        
        const BUTTON_LABELS = {
            send: 'Send',
            cancel: 'Cancel',
            confirm: 'Confirm',
            dismiss: 'Dismiss',
            snooze: 'Snooze',
            pause: 'Pause',
            resume: 'Resume',
            close: 'Close'
        };

        // Main notification data handler
        window.electronAPI.ipcRenderer.on('notification-data', (event, data) => {
            console.log('Received notification data:', data);
            notificationData = data;
            notificationId = data.id;
            setupNotification(data);
        });

        // Update handler
        window.electronAPI.ipcRenderer.on('notification-update', (event, data) => {
            console.log('Received notification update:', data);
            notificationData = { ...notificationData, ...data };
            updateNotificationContent(notificationData);
        });

        // Progress update handler
        window.electronAPI.ipcRenderer.on('progress-update', (event, progress) => {
            console.log('Progress update:', progress);
            updateProgress(progress);
        });

        // Progress indeterminate handler
        window.electronAPI.ipcRenderer.on('progress-indeterminate', (event, indeterminate) => {
            setProgressIndeterminate(indeterminate);
        });

        // Animation handlers
        window.electronAPI.ipcRenderer.on('play-animation', (event, animation) => {
            playEntranceAnimation(animation);
        });

        window.electronAPI.ipcRenderer.on('play-close-animation', () => {
            playExitAnimation();
        });

        function setupNotification(data) {
            const container = document.getElementById('notificationContainer');
            if (!container) {
                console.error('Notification container not found');
                return;
            }

            // Apply theme and base styling
            applyTheme(container, data);
            
            // Set up basic content
            setupBasicContent(container, data);
            
            // Set up type-specific content
            setupTypeSpecificContent(container, data);
            
            // Set up priority indicator
            setupPriorityIndicator(container, data);
            
            // Set up badge if applicable
            setupBadge(container, data);
            
            // Set up drag functionality if enabled
            setupDragFunctionality(container, data);
            
            // Set up auto-close logic
            setupAutoClose(container, data);
            
            // Play entrance animation
            setTimeout(() => playEntranceAnimation(data.animation || 'slide'), 100);
        }

        function applyTheme(container, data) {
            const themeClass = data.theme ? 'theme-' + data.theme : 'theme-windows';
            const colorSchemeClass = data.colorScheme === 'dark' ? 'dark' : '';
            const priorityClass = data.priority ? 'priority-' + data.priority : 'priority-normal';
            
            container.className = `notification-container ${data.type || 'info'} ${themeClass} ${colorSchemeClass} ${priorityClass}`.trim();
        }

        function setupBasicContent(container, data) {
            const icon = container.querySelector('.notification-icon');
            const title = container.querySelector('.notification-title');
            const subtitle = container.querySelector('.notification-subtitle');
            const message = container.querySelector('.notification-message');
            const time = container.querySelector('.notification-time');
            const image = container.querySelector('.notification-image');
            
            // Set icon
            if (icon) {
                icon.innerHTML = data.icon || NOTIFICATION_ICONS[data.type] || NOTIFICATION_ICONS.info;
            }
            
            // Set text content
            if (title) title.textContent = data.title || 'Notification';
            if (subtitle && data.subtitle) {
                subtitle.textContent = data.subtitle;
                subtitle.style.display = 'block';
            }
            if (message) message.textContent = data.message || '';
            if (time) time.textContent = data.timestamp || new Date().toLocaleTimeString().slice(0, 5);
            
            // Set image if provided
            if (image && data.image) {
                const img = image.querySelector('img');
                if (img) {
                    img.src = data.image;
                    image.style.display = 'block';
                }
            }
        }

        function setupTypeSpecificContent(container, data) {
            switch (data.type) {
                case 'progress':
                case 'download':
                case 'upload':
                case 'loading':
                    setupProgressContent(container, data);
                    break;
                    
                case 'reply':
                case 'input':
                    setupReplyContent(container, data);
                    break;
                    
                case 'confirmation':
                    setupConfirmationContent(container, data);
                    break;
                    
                case 'achievement':
                case 'celebration':
                    setupAchievementContent(container, data);
                    break;
                    
                case 'weather':
                    setupWeatherContent(container, data);
                    break;
                    
                case 'update':
                case 'system':
                    setupUpdateContent(container, data);
                    break;
                    
                case 'reminder':
                case 'calendar':
                    setupReminderContent(container, data);
                    break;
                    
                default:
                    setupBasicAutoClose(container, data);
                    break;
            }
            
            // Set up action buttons if provided
            if (data.actions && data.actions.length > 0) {
                setupActionButtons(container, data.actions);
            }
        }

        function setupProgressContent(container, data) {
            const progressContainer = container.querySelector('.progress-container');
            const progressText = container.querySelector('.progress-text');
            const progressSpeed = container.querySelector('.progress-speed');
            const progressTime = container.querySelector('.progress-time');
            const progressActions = container.querySelector('.progress-actions');
            
            if (progressContainer) {
                progressContainer.style.display = 'block';
                
                // Set initial progress
                updateProgress(data.progress || 0);
                
                // Set indeterminate if specified
                if (data.indeterminate) {
                    setProgressIndeterminate(true);
                }
                
                // Show speed and time if provided
                if (progressSpeed && data.speed) {
                    progressSpeed.textContent = data.speed;
                    progressSpeed.style.display = 'block';
                }
                
                if (progressTime && data.timeRemaining) {
                    progressTime.textContent = data.timeRemaining;
                    progressTime.style.display = 'block';
                }
                
                // Show action buttons if enabled
                if (progressActions && (data.showCancel || data.showPause)) {
                    const pauseBtn = progressActions.querySelector('.progress-pause');
                    const cancelBtn = progressActions.querySelector('.progress-cancel');
                    
                    if (data.showPause && pauseBtn) {
                        pauseBtn.style.display = 'inline-block';
                    }
                    if (data.showCancel && cancelBtn) {
                        cancelBtn.style.display = 'inline-block';
                    }
                    
                    if (data.showCancel || data.showPause) {
                        progressActions.style.display = 'block';
                    }
                }
            }
        }

        function setupReplyContent(container, data) {
            const replyContainer = container.querySelector('.reply-container');
            const input = container.querySelector('.reply-input');
            const textarea = container.querySelector('.reply-textarea');
            const validation = container.querySelector('.input-validation');
            
            if (replyContainer) {
                replyContainer.style.display = 'block';
                
                // Choose input type
                const activeInput = data.multiline ? textarea : input;
                const inactiveInput = data.multiline ? input : textarea;
                
                activeInput.style.display = 'block';
                inactiveInput.style.display = 'none';
                
                // Set placeholder
                activeInput.placeholder = data.placeholder || 'Type your reply...';
                
                // Set input attributes
                if (data.maxLength) activeInput.maxLength = data.maxLength;
                if (data.inputType && !data.multiline) input.type = data.inputType;
                if (data.required) activeInput.required = true;
                
                // Focus after animation
                setTimeout(() => activeInput.focus(), 200);
                
                // Set up validation if provided
                if (data.validation) {
                    activeInput.addEventListener('input', () => {
                        validateInput(activeInput, data.validation, validation);
                    });
                }
            }
        }

        function setupConfirmationContent(container, data) {
            setupActionButtons(container, [
                { 
                    id: 'confirm', 
                    label: data.confirmText || 'Confirm', 
                    type: data.destructive ? 'danger' : 'primary' 
                },
                { 
                    id: 'cancel', 
                    label: data.cancelText || 'Cancel', 
                    type: 'secondary' 
                }
            ]);
        }

        function setupAchievementContent(container, data) {
            const achievementContent = container.querySelector('.achievement-content');
            const level = container.querySelector('.achievement-level');
            const points = container.querySelector('.achievement-points');
            const confetti = container.querySelector('.confetti-container');
            
            if (achievementContent) {
                achievementContent.style.display = 'block';
                
                if (level && data.level) {
                    level.textContent = data.level;
                }
                
                if (points && data.points) {
                    points.textContent = `+${data.points} points`;
                }
                
                // Add gradient effect
                if (data.gradient) {
                    container.classList.add('gradient-bg');
                }
                
                // Show confetti
                if (data.showConfetti && confetti) {
                    createConfetti(confetti);
                }
            }
        }

        function setupWeatherContent(container, data) {
            const weatherContent = container.querySelector('.weather-content');
            const temperature = container.querySelector('.weather-temperature');
            const condition = container.querySelector('.weather-condition');
            const humidity = container.querySelector('.weather-humidity');
            const location = container.querySelector('.weather-location');
            
            if (weatherContent) {
                weatherContent.style.display = 'block';
                
                if (temperature && data.temperature) {
                    temperature.textContent = data.temperature;
                }
                
                if (condition && data.condition) {
                    condition.textContent = data.condition;
                }
                
                if (humidity && data.humidity) {
                    humidity.textContent = `Humidity: ${data.humidity}`;
                }
                
                if (location && data.location) {
                    location.textContent = data.location;
                }
            }
        }

        function setupUpdateContent(container, data) {
            const updateContent = container.querySelector('.update-content');
            const version = container.querySelector('.update-version');
            const mandatory = container.querySelector('.update-mandatory');
            
            if (updateContent) {
                updateContent.style.display = 'block';
                
                if (version && data.version) {
                    version.textContent = `Version ${data.version}`;
                }
                
                if (mandatory && data.mandatory) {
                    mandatory.style.display = 'block';
                }
                
                // Add action buttons for updates
                const actions = [
                    { id: 'update', label: 'Update Now', type: 'primary' }
                ];
                
                if (!data.mandatory) {
                    actions.push({ id: 'later', label: 'Later', type: 'secondary' });
                }
                
                if (data.changelogUrl) {
                    actions.push({ id: 'changelog', label: 'View Changes', type: 'secondary' });
                }
                
                setupActionButtons(container, actions);
            }
        }

        function setupReminderContent(container, data) {
            const snoozeOptions = container.querySelector('.snooze-options');
            
            // Set up main action buttons
            setupActionButtons(container, [
                { id: 'dismiss', label: 'Dismiss', type: 'primary' },
                { id: 'snooze', label: 'Snooze', type: 'secondary' }
            ]);
            
            // Set up snooze options if provided
            if (data.snoozeOptions && data.snoozeOptions.length > 0 && snoozeOptions) {
                const buttonsContainer = snoozeOptions.querySelector('.snooze-buttons');
                if (buttonsContainer) {
                    buttonsContainer.innerHTML = '';
                    
                    data.snoozeOptions.forEach(minutes => {
                        const btn = document.createElement('button');
                        btn.className = 'snooze-btn';
                        btn.dataset.minutes = minutes.toString();
                        btn.textContent = formatSnoozeTime(minutes);
                        btn.onclick = () => snoozeNotification(minutes);
                        buttonsContainer.appendChild(btn);
                    });
                }
            }
        }

        function setupActionButtons(container, actions) {
            const actionButtons = container.querySelector('.action-buttons');
            if (!actionButtons || !actions.length) return;
            
            actionButtons.innerHTML = '';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = `action-button ${action.type || 'secondary'}`;
                button.textContent = action.label;
                button.onclick = () => handleActionClick(action.id, action);
                
                if (action.icon) {
                    button.innerHTML = `${action.icon} ${action.label}`;
                }
                
                actionButtons.appendChild(button);
            });
            
            actionButtons.style.display = 'flex';
        }

        function setupPriorityIndicator(container, data) {
            const priorityIndicator = container.querySelector('.priority-indicator');
            if (priorityIndicator && data.priority && data.priority !== 'normal') {
                priorityIndicator.className = `priority-indicator priority-${data.priority}`;
            }
        }

        function setupBadge(container, data) {
            const badge = container.querySelector('.notification-badge');
            if (badge && data.badge) {
                const badgeCount = badge.querySelector('.badge-count');
                
                if (data.badge.count && data.badge.count > 0) {
                    if (badgeCount) badgeCount.textContent = data.badge.count.toString();
                    badge.style.display = 'block';
                    
                    if (data.badge.color) {
                        badge.style.backgroundColor = data.badge.color;
                    }
                }
            }
        }

        function setupDragFunctionality(container, data) {
            // This would implement drag-to-dismiss functionality
            // Implementation details would depend on specific requirements
        }

        function setupBasicAutoClose(container, data) {
            const autoProgress = container.querySelector('.notification-progress');
            
            if (autoProgress && !data.fixed && !data.requireInteraction && !data.persistent) {
                const basicTypes = ['info', 'success', 'warning', 'error', 'custom', 'achievement', 'weather', 'tip', 'news'];
                
                if (basicTypes.includes(data.type)) {
                    autoProgress.style.animation = 'none';
                    autoProgress.offsetHeight; // Trigger reflow
                    autoProgress.style.animation = `progress ${(data.duration || 5000) / 1000}s linear forwards`;
                }
            } else if (autoProgress) {
                autoProgress.style.width = '0%';
            }
        }

        function updateNotificationContent(data) {
            const container = document.getElementById('notificationContainer');
            if (container) {
                setupBasicContent(container, data);
                applyTheme(container, data);
            }
        }

        function updateProgress(progress) {
            const progressValue = Math.max(0, Math.min(100, progress));
            const progressBar = container.querySelector('.progress-bar');
            const progressText = container.querySelector('.progress-text');

            if (progressBar) progressBar.style.width = `${progressValue}%`;
            if (progressText) progressText.textContent = `${Math.round(progressValue)}%`;

            // Auto-complete handling
            if (progressValue >= 100) {
                setTimeout(() => {
                    const container = document.getElementById('notificationContainer');
                    if (container) {
                        container.classList.remove('progress', 'download', 'upload', 'loading');
                        container.classList.add('success');
                        
                        const icon = container.querySelector('.notification-icon');
                        const title = container.querySelector('.notification-title');
                        if (icon) icon.innerHTML = NOTIFICATION_ICONS.success;
                        if (title) title.textContent = 'Completed';
                        
                        setTimeout(() => closeNotification(), 2000);
                    }
                }, 500);
            }
        }

        function setProgressIndeterminate(indeterminate) {
            const progressBar = container.querySelector('.progress-bar');
            const progressSpinner = container.querySelector('.progress-spinner');
            
            if (indeterminate) {
                if (progressBar) progressBar.style.display = 'none';
                if (progressSpinner) progressSpinner.style.display = 'block';
            } else {
                if (progressBar) progressBar.style.display = 'block';
                if (progressSpinner) progressSpinner.style.display = 'none';
            }
        }

        function playEntranceAnimation(animation) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            container.classList.add('show');
            
            switch (animation) {
                case 'bounce':
                    container.classList.add('animate-bounce');
                    break;
                case 'zoom':
                    container.classList.add('animate-zoom');
                    break;
                case 'flip':
                    container.classList.add('animate-flip');
                    break;
                case 'fade':
                    container.classList.add('animate-fade');
                    break;
                case 'slide':
                default:
                    container.classList.add('animate-slide');
                    break;
            }
        }

        function playExitAnimation() {
            const container = document.getElementById('notificationContainer');
            if (container) {
                container.classList.add('hiding');
                container.classList.remove('show');
            }
        }

        function closeNotification() {
            playExitAnimation();
            setTimeout(() => {
                window.close();
            }, 300);
        }

        function sendReply() {
            const replyInput = document.querySelector('.reply-input:not([style*="display: none"])') || 
                              document.querySelector('.reply-textarea:not([style*="display: none"])');
            
            if (replyInput && notificationId) {
                const response = replyInput.value.trim();
                
                // Validate if required
                if (notificationData.required && !response) {
                    showValidationError('This field is required');
                    return;
                }
                
                // Validate with regex if provided
                if (notificationData.validation && !notificationData.validation.test(response)) {
                    showValidationError('Invalid input format');
                    return;
                }
                
                window.electronAPI.ipcRenderer.send('reply-notification-response', { 
                    id: notificationId, 
                    response: response 
                });
                closeNotification();
            }
        }

        function cancelReply() {
            if (notificationId) {
                window.electronAPI.ipcRenderer.send('reply-notification-response', { 
                    id: notificationId, 
                    response: null 
                });
                closeNotification();
            }
        }

        function handleActionClick(actionId, action) {
            console.log(`Action clicked: ${actionId}`);
            
            switch (actionId) {
                case 'confirm':
                    window.electronAPI.ipcRenderer.send('notification-action', {
                        id: notificationId,
                        action: 'confirm'
                    });
                    break;
                case 'cancel':
                    window.electronAPI.ipcRenderer.send('notification-action', {
                        id: notificationId,
                        action: 'cancel'
                    });
                    break;
                case 'snooze':
                    showSnoozeOptions();
                    return; // Don't close yet
                case 'dismiss':
                    window.electronAPI.ipcRenderer.send('notification-action', {
                        id: notificationId,
                        action: 'dismiss'
                    });
                    break;
                default:
                    window.electronAPI.ipcRenderer.send('notification-action', {
                        id: notificationId,
                        action: actionId,
                        data: action
                    });
                    break;
            }
            
            closeNotification();
        }

        function showSnoozeOptions() {
            const snoozeOptions = document.querySelector('.snooze-options');
            if (snoozeOptions) {
                snoozeOptions.style.display = 'block';
            }
        }

        function snoozeNotification(minutes) {
            window.electronAPI.ipcRenderer.send('notification-action', {
                id: notificationId,
                action: 'snooze',
                data: { minutes }
            });
            closeNotification();
        }

        function pauseProgress() {
            window.electronAPI.ipcRenderer.send('notification-action', {
                id: notificationId,
                action: 'pause'
            });
        }

        function cancelProgress() {
            window.electronAPI.ipcRenderer.send('notification-action', {
                id: notificationId,
                action: 'cancel'
            });
            closeNotification();
        }

        function validateInput(input, validation, validationElement) {
            const isValid = validation.test(input.value);
            
            if (isValid) {
                input.classList.remove('invalid');
                if (validationElement) validationElement.style.display = 'none';
            } else {
                input.classList.add('invalid');
            }
            
            return isValid;
        }

        function showValidationError(message) {
            const validation = document.querySelector('.input-validation');
            if (validation) {
                validation.textContent = message;
                validation.style.display = 'block';
            }
        }

        function createConfetti(container) {
            // Create confetti animation
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.backgroundColor = getRandomColor();
                container.appendChild(confetti);
            }
        }

        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function formatSnoozeTime(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) {
                    return `${hours} hour${hours > 1 ? 's' : ''}`;
                } else {
                    return `${hours}h ${remainingMinutes}m`;
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (notificationData?.type === 'reply' || notificationData?.type === 'input') {
                    cancelReply();
                } else {
                    closeNotification();
                }
            } else if (e.key === 'Enter' && (notificationData?.type === 'reply' || notificationData?.type === 'input')) {
                sendReply();
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            if (progressInterval) clearInterval(progressInterval);
        });
    </script>
</body>
</html>